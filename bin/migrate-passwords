#!/usr/bin/env php
<?php

/**
 * Script de migration pour hasher les mots de passe existants
 * À exécuter UNE SEULE FOIS après le déploiement de la correction
 */

require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../config/bootstrap.php';

use Mns\Buggy\Core\MySqlConnector;

echo "=== Migration des mots de passe ===\n\n";
echo "⚠️  Ce script va hasher tous les mots de passe en clair.\n";
echo "⚠️  Il ne doit être exécuté qu'UNE SEULE FOIS.\n\n";

// Connexion à la base de données
$pdo = MySqlConnector::getInstance()->getConnection();

// Récupérer tous les utilisateurs
$stmt = $pdo->query("SELECT id, email, password FROM mns_user");
$users = $stmt->fetchAll(PDO::FETCH_ASSOC);

$updated = 0;
$skipped = 0;

foreach ($users as $user) {
    // Vérifier si le mot de passe est déjà hashé (commence par $2y$ pour bcrypt)
    if (strpos($user['password'], '$2y$') === 0) {
        echo "✓ Utilisateur #{$user['id']} ({$user['email']}) : Déjà hashé, ignoré\n";
        $skipped++;
        continue;
    }
    
    // Hasher le mot de passe
    $hashedPassword = password_hash($user['password'], PASSWORD_DEFAULT);
    
    // Mettre à jour en base
    $updateStmt = $pdo->prepare("UPDATE mns_user SET password = :password WHERE id = :id");
    $updateStmt->execute([
        'password' => $hashedPassword,
        'id' => $user['id']
    ]);
    
    echo "✓ Utilisateur #{$user['id']} ({$user['email']}) : Mot de passe hashé\n";
    $updated++;
}

echo "\n=== Migration terminée ===\n";
echo "✅ {$updated} mot(s) de passe mis à jour\n";
echo "⏭️  {$skipped} mot(s) de passe déjà hashés (ignorés)\n";
echo "\nVous pouvez maintenant vous connecter avec les mêmes mots de passe qu'avant.\n";

